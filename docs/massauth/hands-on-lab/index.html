<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://stoneassemblies.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://stoneassemblies.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://stoneassemblies.github.io/main.9663470f12e178143d7d2a5d0fc4405b2869739ab1fe1c8409db227794f93100de1e34c604c6167ef2491dbcbff14b324d4da9f3b03d7460a278d951aaa6ba71.css integrity="sha512-lmNHDxLheBQ9fSpdD8RAWyhpc5qx/hyECdsid5T5MQDeHjTGBMYWfvJJHby/8UsyTU2p87A9dGCieNlRqqa6cQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><link rel=stylesheet href=css/animate.min.css><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Hands-on Lab - Stone Assemblies</title><meta name=description content="MassAuth Hands-on Lab."><link rel=canonical href=https://stoneassemblies.github.io/docs/massauth/hands-on-lab/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/stoneassemblies-logo.png"><meta name=twitter:title content="Hands-on Lab"><meta name=twitter:description content="MassAuth Hands-on Lab."><meta name=twitter:site content="@alexfdezsauco"><meta name=twitter:creator content="@alexfdezsauco"><meta property="og:title" content="Hands-on Lab"><meta property="og:description" content="MassAuth Hands-on Lab."><meta property="og:type" content="article"><meta property="og:url" content="/docs/massauth/hands-on-lab/"><meta property="og:image" content="/stoneassemblies-logo.png"><meta property="article:published_time" content="2020-11-16T13:59:39+01:00"><meta property="article:modified_time" content="2020-11-16T13:59:39+01:00"><meta property="og:site_name" content="Stone Assemblies"><meta property="article:publisher" content="https://www.facebook.com/"><meta property="article:author" content="https://www.facebook.com/"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/stoneassemblies.github.io\/"},{"@type":"ListItem","position":3,"name":"Docs","item":"https:\/\/stoneassemblies.github.io\/\/docs\/"},{"@type":"ListItem","position":4,"name":"Massauth","item":"https:\/\/stoneassemblies.github.io\/\/docs\/massauth\/"},{"@type":"ListItem","position":5,"name":"Hands on Lab","item":"https:\/\/stoneassemblies.github.io\/\/docs\/massauth\/hands-on-lab\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://stoneassemblies.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://stoneassemblies.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://stoneassemblies.github.io/favicon-16x16.png><link rel=manifest href=https://stoneassemblies.github.io/site.webmanifest></head><body class="docs single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://stoneassemblies.github.io/><img src=https://stoneassemblies.github.io/stoneassemblies-logo.png width=45px>
Stone Assemblies</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/stoneassemblies><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://stoneassemblies.github.io/docs/stoneassemblies/introduction/>Documentation</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>stoneassemblies</h3><ul class=list-unstyled><li><a class=docs-link href=https://stoneassemblies.github.io/docs/stoneassemblies/introduction/>What is StoneAssemblies?</a></li></ul><h3>massauth</h3><ul class=list-unstyled><li><a class=docs-link href=https://stoneassemblies.github.io/docs/massauth/what-is/>What is MassAuth?</a></li><li><a class="docs-link active" href=https://stoneassemblies.github.io/docs/massauth/hands-on-lab/>Hands-on Lab</a></li></ul><h3>extensibility</h3><ul class=list-unstyled><li><a class=docs-link href=https://stoneassemblies.github.io/docs/extensibility/what-is/>What is Extensibility?</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#step-1-setup-the-workspace>Step 1: Setup the workspace</a></li><li><a href=#step-2-contract-first>Step 2: Contract first</a></li><li><a href=#step-3-implementing-rules>Step 3: Implementing rules</a></li><li><a href=#step-4-implementing-services>Step 4: Implementing services</a></li><li><a href=#step-5-hosting-rules>Step 5: Hosting rules</a></li><li><a href=#step-6-build-run-and-test>Step 6: Build, run and test</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Hands-on Lab</h1><p class=lead></p><blockquote><p>Straight forward Hands-on Lab for StoneAssemblies.MassAuth</p></blockquote><h2 id=prerequisites>Prerequisites<a href=#prerequisites class=anchor aria-hidden=true>#</a></h2><ul><li>Visual Studio 2019 (16.9.3)</li><li>Docker (2.3.0.4)</li><li><a href=https://cakebuild.net/>CakeBuild</a> (1.1.0)</li><li><a href=https://github.com/dotnet/tye/blob/main/docs/getting_started.md>Tye</a> (0.9.0-alpha.21380.1)</li></ul><blockquote><p>The final source code of this Hands-on Lab is in the <a href=https://github.com/stoneassemblies/StoneAssemblies.MassAuth.QuickStart>StoneAssemblies.MassAuth.QuickStart</a> repository available on GitHub. You can directly clone this repository or just follow the steps outlined below.</p></blockquote><h2 id=step-1-setup-the-workspace>Step 1: Setup the workspace<a href=#step-1-setup-the-workspace class=anchor aria-hidden=true>#</a></h2><p>To setup the workspace, open a <strong>PowerShell</strong> console and run the following commands:</p><script src=https://gist.github.com/alexfdezsauco/998e4f86c347c9b9d8da1cae9a2841bf.js></script><p>After executing theses commands, a Visual Studio solution file StoneAssemblies.MassAuth.QuickStart.sln is created, which includes the following projects:</p><table><thead><tr><th>Project</th><th>Description</th></tr></thead><tbody><tr><td>StoneAssemblies.MassAuth.QuickStart.<strong>Messages</strong></td><td>Class library for messages specification.</td></tr><tr><td>StoneAssemblies.MassAuth.QuickStart.<strong>Rules</strong></td><td>Class library to implement rules for messages.</td></tr><tr><td>StoneAssemblies.MassAuth.QuickStart.<strong>Services</strong></td><td>Web API to host the services that require to be authorized by rules.</td></tr><tr><td>StoneAssemblies.MassAuth.QuickStart.<strong>AuthServer</strong></td><td>Authorization server to host the rules for messages.</td></tr></tbody></table><p>The commands also add the required NuGet packages and project references.</p><p>The workspace also include two more aditional files. The <code>build.cake</code>, a cake based build script to ensure the required output and location and the <code>deployment\tye\tye.yaml</code> that will help us to run and debug the solution.</p><h2 id=step-2-contract-first>Step 2: Contract first<a href=#step-2-contract-first class=anchor aria-hidden=true>#</a></h2><p>Let&rsquo;s add a bit of complexity to the generated problem, related with weather forecast. For instance, let&rsquo;s say we will allow to request forecast from a certain date, as some forecasts may not be available due to the complexity of the calculations.</p><p>For that purpose, we will add the following class to the <strong>Message</strong> project, to request the weather forecast with start date as argument.</p><script src=https://gist.github.com/alexfdezsauco/52e10bdad84c154a35cfd2be104d7333.js></script><h2 id=step-3-implementing-rules>Step 3: Implementing rules<a href=#step-3-implementing-rules class=anchor aria-hidden=true>#</a></h2><p>Now we are ready to implement some rules for the specified message. Continuing with our scenario, let&rsquo;s say the forecast data is only available from today and up to 10 days. This operation could be more complex through query to an external database, but for simplicity it will be implemented as follows in the <strong>Rules</strong> project.</p><script src=https://gist.github.com/alexfdezsauco/6b5d4d0b37c3351cb34ddb2f008a3c76.js></script><h2 id=step-4-implementing-services>Step 4: Implementing services<a href=#step-4-implementing-services class=anchor aria-hidden=true>#</a></h2><p>It&rsquo;s time to complete the <em>WeatherForecastController</em> implementation in the <strong>Services</strong> project. It should look like this.</p><script src=https://gist.github.com/alexfdezsauco/cfde54e975924aaf39ff3d7664b7fdb2.js></script><p>Notice the usage of <em>AuthorizeByRule</em> attribute on the Get method, to indicate that the input message <em>WeatherForecastRequestMessage</em> must be processed and validated by the authorization engine before the method execution.</p><p>We also have to update the <em>Startup</em> class implementation.</p><script src=https://gist.github.com/alexfdezsauco/86b681686642537c8d945149031a2302.js></script><p>Basically, the <em>AddMassAuth</em> service collection extension method is called to register the library services and also ensure the communication through the message broker. Remember, StoneAssemblies.MassAuth is built on top of <a href=https://masstransit-project.com/>MassTransit</a>. Finally, to read the configuration fro environment variables we must update the <em>Program</em> class to this.</p><script src=https://gist.github.com/alexfdezsauco/2d6e33f15ee7077577727498a387e8c3.js></script><h2 id=step-5-hosting-rules>Step 5: Hosting rules<a href=#step-5-hosting-rules class=anchor aria-hidden=true>#</a></h2><p>The <strong>AuthServer</strong> project is responsible for hosting the rules. The rules assemblies are loaded as plugins via <a href=https://stoneassemblies.github.io/docs/extensibility/what-is/>StoneAssemblies.Extensibility</a>. Since the extensibility system is NuGet based, rules and messages must be provisioned as NuGet packages.</p><blockquote><p>There is a production ready <a href=https://hub.docker.com/r/stoneassemblies/massauth-server>StoneAssemblies.MassAuth.Server</a> docker image available in <a href=https://hub.docker.com>DockerHub</a>.</p></blockquote><p>For debugging or even for customization purpose could be useful build your own rule host server project and the <em>Startup</em> class implementation must be updated to initialize the extensibility system and load rules.</p><script src=https://gist.github.com/alexfdezsauco/6384b11ed441d6efb06950e5e6babdc9.js></script><p>Again, to read the configuration from the environment variables the <em>Program</em> file must be updated like this.</p><script src=https://gist.github.com/alexfdezsauco/9cd40c62c6efba8fc164d73dafe3b117.js></script><h2 id=step-6-build-run-and-test>Step 6: Build, run and test<a href=#step-6-build-run-and-test class=anchor aria-hidden=true>#</a></h2><p>In order to build and run the project, open a <strong>PowerShell</strong> terminal in the working directory and run following commands.</p><pre><code class=language-PowerShell>&gt; dotnet cake
&gt; cd deployment/tye
&gt; tye run
</code></pre><p>Open your browser and navigate to <a href=http://localhost:8000>http://localhost:8000</a> to display the Tye user interface and ensure that everything is working.</p><p>Open a new <strong>PowerShell</strong> terminal and try the following commands:</p><p>A) <strong>Input</strong>: Valid request</p><pre><code class=language-PowerShell>Invoke-WebRequest http://localhost:6001/WeatherForecast?StartDate=$([System.DateTime]::Now.AddDays(1).Date)
</code></pre><p><strong>Output:</strong></p><pre><code>StatusCode        : 200
StatusDescription : OK
Content           : [{&quot;date&quot;:&quot;2021-08-24T00:00:00&quot;,&quot;temperatureC&quot;:21,&quot;temperatureF&quot;:69,&quot;summary&quot;:&quot;Chilly&quot;},{&quot;date&quot;:&quot;2021-08-25T00:00:00&quot;,&quot;temperatureC&quot;:4,&quot;tem
                    peratureF&quot;:39,&quot;summary&quot;:&quot;Chilly&quot;},{&quot;date&quot;:&quot;2021-08-26T00:00:00...
RawContent        : HTTP/1.1 200 OK
                    Transfer-Encoding: chunked
                    Content-Type: application/json; charset=utf-8
                    Date: Sun, 22 Aug 2021 18:38:21 GMT
                    Server: Kestrel

                    [{&quot;date&quot;:&quot;2021-08-24T00:00:00&quot;,&quot;temperatureC&quot;:21,&quot;te...
Forms             : {}
Headers           : {[Transfer-Encoding, chunked], [Content-Type, application/json; charset=utf-8], [Date, Sun, 22 Aug 2021 18:38:21 GMT], [Server, Kestrel]}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 435
</code></pre><p>B) <strong>Input</strong>: Out of range request</p><pre><code class=language-PowerShell>Invoke-WebRequest http://localhost:6001/WeatherForecast?StartDate=$([System.DateTime]::Now.AddDays(11).Date)
</code></pre><p><strong>Output:</strong></p><pre><code>Invoke-WebRequest : The remote server returned an error: (401) Unauthorized.
At line:1 char:1
+ Invoke-WebRequest http://localhost:6001/WeatherForecast?StartDate=$([ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebRequest], WebException
    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand
</code></pre><div class="docs-navigation d-flex justify-content-between"><a href=https://stoneassemblies.github.io/docs/massauth/what-is/><div class="card my-1"><div class="card-body py-2">&larr; What is MassAuth?</div></div></a><a class=ms-auto href=https://stoneassemblies.github.io/docs/stoneassemblies/introduction/><div class="card my-1"><div class="card-body py-2">What is StoneAssemblies? &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.netlify.com/>Netlify</a>, <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://stoneassemblies.github.io/js/highlight.min.c3931948f526af1660500afab63a1c5876429a9d73fe202c24138438785ffc812c11adb8234229f1ff2a6be15b1e9ff3af31eebaacf9c8130e0cfa4fe96cdf59.js integrity="sha512-w5MZSPUmrxZgUAr6tjocWHZCmp1z/iAsJBOEOHhf/IEsEa24I0Ip8f8qa+FbHp/zrzHuuqz5yBMODPpP6WzfWQ==" crossorigin=anonymous defer></script><script src=https://stoneassemblies.github.io/main.min.7ab523108435955765bcb88a0ee704f412ba01646b5478e84f3b9feb24f0ce750a14c3f7bd9a62408fe21e41996d361a9eb29f77e85dfe77b7e17f7623bd3a97.js integrity="sha512-erUjEIQ1lVdlvLiKDucE9BK6AWRrVHjoTzuf6yTwznUKFMP3vZpiQI/iHkGZbTYanrKfd+hd/ne34X92I706lw==" crossorigin=anonymous defer></script><script src=https://stoneassemblies.github.io/index.min.d290adaef20a92762152f5d857e7ee6420c4c75bfd53a00b820ac23b15c4a600de30b68f6edabbf8fca2f776b10b33c444410d91e8707b9dad2de6b4bd55816c.js integrity="sha512-0pCtrvIKknYhUvXYV+fuZCDEx1v9U6ALggrCOxXEpgDeMLaPbtq7+Pyi93axCzPEREENkehwe52tLea0vVWBbA==" crossorigin=anonymous defer></script></body></html>